<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›²äººå°èˆªåŠ©æ‰‹æ¸¬è©¦ç‰ˆ</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC-TIvRKEtaXQONKgVK86ZAvYEnsppGEzU&libraries=places,geometry"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; background-color: #f9f9f9; }
        #status { color: blue; font-weight: bold; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ddd; }
        #log { margin-top: 20px; background: #fff; padding: 15px; border-radius: 8px; height: 400px; overflow-y: scroll; border: 1px solid #ccc; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; }
        .place-item { border-bottom: 1px solid #eee; padding: 10px 0; }
    </style>
</head>
  <body>
    <h1>AI å°èˆªåŠ©æ‰‹ ğŸ¤–</h1>
    <p>ç‹€æ…‹ï¼š<span id="status">æº–å‚™ä¸­...</span></p>
    <button onclick="startNavigation()">é–‹å§‹å³æ™‚å°èˆª</button>
    <div id="log"><h3>å³æ™‚åµæ¸¬ç´€éŒ„ï¼š</h3></div>

    <script>
      let service;
      let isSearching = false; 
      let lastQueryPos = null; // å„²å­˜ä¸Šä¸€æ¬¡ç™¼é€ API çš„ä½ç½®
      let lastSpokenTime = {}; 

      function startNavigation() {
        speak("ç³»çµ±å•Ÿå‹•ï¼Œç§»å‹•è¶…é50å…¬å°ºå°‡è‡ªå‹•æ›´æ–°åœ°æ¨™");
        navigator.geolocation.watchPosition(updatePosition, (err) => {
            console.error(err);
        }, { enableHighAccuracy: true, timeout: 10000 });
      }

      async function updatePosition(position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const myPos = new google.maps.LatLng(lat, lng);

        document.getElementById('status').innerText = `å®šä½æˆåŠŸ: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;

        // --- æ ¸å¿ƒçœéŒ¢é‚è¼¯ï¼šç§»å‹•ä¸è¶³ 50m ä¸é‡æ–°æŠ“ API ---
        if (lastQueryPos) {
            const traveled = google.maps.geometry.spherical.computeDistanceBetween(myPos, lastQueryPos);
            if (traveled < 50) {
                console.log(`ç›®å‰ç§»å‹• ${Math.round(traveled)}mï¼Œæœªé” 50m é–€æª»ï¼Œç¯€çœ API æ¬¡æ•¸ä¸­`);
                return; 
            }
        }

        if (isSearching) return;
        isSearching = true;

        try {
            if (!service) service = new google.maps.places.PlacesService(document.createElement('div'));

            const request = {
                location: myPos,
                radius: 500,
                // query æ”¹æˆ 'åœ°æ¨™' æˆ– 'å•†åº—' ä¾†æŠ“å–æ›´å¤šå…ƒçš„çµæœ
                query: 'åœ°æ¨™' 
            };

            service.textSearch(request, (results, status) => {
                isSearching = false; 
                if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                    lastQueryPos = myPos; // æˆåŠŸæ‰æ›´æ–°åŸºæº–é»
                    document.getElementById('status').innerText = "æˆåŠŸæ›´æ–°å‘¨é‚Šåœ°æ¨™ï¼";
                    renderAndSpeak(myPos, results);
                }
            });
        } catch (e) { isSearching = false; }
    }

    function renderAndSpeak(myPos, results) {
        const logBox = document.getElementById('log');
        logBox.innerHTML = `<h3>å‘¨é‚Šåµæ¸¬çµæœï¼š</h3>`;

        // 1. è¨ˆç®—æ‰€æœ‰åœ°é»çš„è·é›¢ä¸¦æ’åº
        const sortedPlaces = results.map(place => {
            const shopPos = place.geometry.location;
            return {
                name: place.name,
                dist: Math.round(google.maps.geometry.spherical.computeDistanceBetween(myPos, shopPos)),
                heading: google.maps.geometry.spherical.computeHeading(myPos, shopPos)
            };
        }).sort((a, b) => a.dist - b.dist); // ç”±è¿‘åˆ°é æ’åº

        // 2. é¡¯ç¤ºæ‰€æœ‰çµæœ (æ»¿è¶³ä½ çš„æ¸¬è©¦éœ€æ±‚)
        sortedPlaces.forEach(p => {
            const div = document.createElement('div');
            div.className = 'place-item';
            div.innerHTML = `<strong>ğŸ“ ${p.name}</strong> (${getDirectionText(p.heading)}) - ${p.dist}m`;
            logBox.appendChild(div);
        });

        // 3. èªéŸ³æ’­å ±ï¼šåªå”¸å‡ºæœ€è¿‘çš„ 3 å€‹ï¼Œé¿å…è³‡è¨Šéè¼‰
        const top3 = sortedPlaces.slice(0, 3);
        top3.forEach(p => {
            const now = Date.now();
            // 200å…¬å°ºå…§ä¸”å…©åˆ†é˜å…§ä¸é‡è¤‡å”¸åŒä¸€é–“
            if (p.dist < 200 && (!lastSpokenTime[p.name] || now - lastSpokenTime[p.name] > 120000)) {
                speak(`${getDirectionText(p.heading)} ${p.dist} å…¬å°ºè™•æœ‰ ${p.name}`);
                lastSpokenTime[p.name] = now;
            }
        });
    }

    function getDirectionText(heading) {
        if (heading > -45 && heading <= 45) return "å‰æ–¹";
        if (heading > 45 && heading <= 135) return "å³æ–¹";
        if (heading < -45 && heading >= -135) return "å·¦æ–¹";
        return "å¾Œæ–¹";
    }

    function speak(text) {
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'zh-TW';
        window.speechSynthesis.speak(msg);
    }
</script>
</body>
</html>