<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›²äººå°èˆªåŠ©æ‰‹æ¸¬è©¦ç‰ˆ</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC-TIvRKEtaXQONKgVK86ZAvYEnsppGEzU&libraries=places,geometry"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
        #status { color: blue; font-weight: bold; }
        #log { margin-top: 20px; background: #f0f0f0; padding: 10px; border-radius: 5px; height: 300px; overflow-y: scroll; }
    </style>
</head>
<body>
    <h1>AI å°èˆªåŠ©æ‰‹ ğŸ¤–</h1>
    <p>ç‹€æ…‹ï¼š<span id="status">æº–å‚™ä¸­...</span></p>
    <button onclick="startNavigation()">é–‹å§‹å³æ™‚å°èˆª</button>
    <div id="log"><h3>å³æ™‚åµæ¸¬ç´€éŒ„ï¼š</h3></div>

    <script>
        // åœ¨ script æ¨™ç±¤å…§é ‚å±¤å®šç¾©è®Šæ•¸ï¼Œé¿å…é‡è¤‡å»ºç«‹ service
        let service;
        let isSearching = false; // é˜²æ­¢é‡ç–Šè«‹æ±‚
        let lastSpokenTime = {}; // ç”¨ä¾†é˜²æ­¢é‡è¤‡æ’­å ±åŒä¸€é–“åº—

        function startNavigation() {
            // 1. å…ˆè§£é–èªéŸ³
            const unlockMsg = new SpeechSynthesisUtterance("ç³»çµ±å•Ÿå‹•ä¸­");
            unlockMsg.lang = 'zh-TW';
            window.speechSynthesis.speak(unlockMsg);

            if (!navigator.geolocation) {
                alert("ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
                return;
            }
            document.getElementById('status').innerText = "å®šä½ä¸­...";

            navigator.geolocation.watchPosition(updatePosition, handleError, {
                enableHighAccuracy: true,
                timeout: 10000, // å¢åŠ åˆ° 10 ç§’é¿å…è¶…æ™‚
                maximumAge: 0
            });
        }

        async function updatePosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const myPos = new google.maps.LatLng(lat, lng); // è½‰æˆ Google åº§æ¨™ç‰©ä»¶æ–¹ä¾¿å¾Œé¢è¨ˆç®—

            document.getElementById('status').innerText = `å®šä½æˆåŠŸ: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;

            if (isSearching) return;
            isSearching = true;

            try {
                if (!service) {
                    service = new google.maps.places.PlacesService(document.createElement('div'));
                }

                const request = {
                    location: myPos,
                    radius: 1000, 
                    type: ['establishment']
                };

                service.nearbySearch(request, (results, status) => {
                    isSearching = false; 
                    const statusDisplay = document.getElementById('status');

                    if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                        statusDisplay.innerText = `æ‰¾åˆ° ${results.length} å€‹åœ°æ¨™ï¼`;
                        statusDisplay.style.color = "green";

                        // é‡è¦ï¼šæ¸…ç©ºèˆŠç´€éŒ„ä¸¦åŸ·è¡Œè™•ç†å‡½å¼
                        const logBox = document.getElementById('log');
                        logBox.innerHTML = "<h3>å³æ™‚åµæ¸¬ç´€éŒ„ï¼š</h3>";

                        results.forEach(place => {
                            processPlace(myPos, place); // å‘¼å«ä½ å®šç¾©çš„è™•ç†å‡½å¼
                        });
                    } else {
                        // å¦‚æœ status æ˜¯ REQUEST_DENIEDï¼Œå°±æ˜¯ API æ¬Šé™æ²’é–‹
                        console.error("API å¤±æ•—åŸå› :", status);
                        statusDisplay.innerText = "API éŒ¯èª¤ä»£ç¢¼: " + status;
                        statusDisplay.style.color = "red";
                    }
                });
            } catch (e) {
                console.error("åŸ·è¡ŒéŒ¯èª¤:", e);
                isSearching = false;
            }
        }

        function processPlace(myPos, place) {
            const shopPos = place.geometry.location;
            const shopName = place.name;
            const distance = Math.round(google.maps.geometry.spherical.computeDistanceBetween(myPos, shopPos));
            
            // --- æ¸¬è©¦é‡é»ï¼šå…ˆä¸ç®¡è·é›¢ï¼Œåªè¦æœåˆ°å°±å°åœ¨ log å€å¡Š ---
            const testLog = document.createElement('p');
            testLog.style.fontSize = "12px";
            testLog.style.color = "#666";
            testLog.innerText = `[åµæ¸¬åˆ°] ${shopName} (è·é›¢ ${distance} å…¬å°º)`;
            document.getElementById('log').appendChild(testLog);

            // é€™è£¡æ‰æ˜¯åŸæœ¬çš„ã€ŒèªéŸ³æ’­å ±é–€æª»ã€
            const heading = google.maps.geometry.spherical.computeHeading(myPos, shopPos);
            let direction = "å‰æ–¹";
            if (heading > 45 && heading < 135) direction = "å³æ–¹";
            else if (heading < -45 && heading > -135) direction = "å·¦æ–¹";
            else if (heading >= 135 || heading <= -135) direction = "å¾Œæ–¹";

            const currentTime = new Date().getTime();
            // å…ˆæŠŠé–€æª»èª¿é«˜ä¸€é»ï¼Œä¾‹å¦‚ 200 å…¬å°ºï¼Œæ–¹ä¾¿ä½ æ¸¬è©¦
            if (distance < 200 && (!lastSpokenTime[shopName] || currentTime - lastSpokenTime[shopName] > 60000)) {
                announce(direction, distance, shopName);
                lastSpokenTime[shopName] = currentTime;
            }
        }

        function announce(dir, dist, name) {
            const text = `${dir} ${dist} å…¬å°ºè™•æœ‰ ${name}`;
            const logEntry = document.createElement('p');
            logEntry.innerText = `[${new Date().toLocaleTimeString()}] ${text}`;
            document.getElementById('log').appendChild(logEntry);

            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'zh-TW';
            window.speechSynthesis.speak(msg);
        }

        function handleError(err) {
            console.warn(`ERROR(${err.code}): ${err.message}`);
        }
    </script>
</body>
</html>