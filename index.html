<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›²äººå°èˆªåŠ©æ‰‹æ¸¬è©¦ç‰ˆ</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC-TIvRKEtaXQONKgVK86ZAvYEnsppGEzU&libraries=places,geometry"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; background-color: #f9f9f9; }
        #status { color: blue; font-weight: bold; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ddd; }
        #log { margin-top: 20px; background: #fff; padding: 15px; border-radius: 8px; height: 400px; overflow-y: scroll; border: 1px solid #ccc; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; }
        .place-item { border-bottom: 1px solid #eee; padding: 8px 0; }
    </style>
</head>
<body>
    <h1>AI å°èˆªåŠ©æ‰‹ ğŸ¤–</h1>
    <p>ç‹€æ…‹ï¼š<span id="status">æº–å‚™ä¸­...</span></p>
    <button onclick="startNavigation()">é–‹å§‹å³æ™‚å°èˆª</button>
    <div id="log"><h3>å³æ™‚åµæ¸¬ç´€éŒ„ï¼š</h3></div>

    <script>
        let service;
        let isSearching = false; 
        let lastSpokenTime = {}; 

        function startNavigation() {
            // èªéŸ³åˆå§‹åŒ–æ¸¬è©¦
            speak("å°èˆªç³»çµ±å·²å•Ÿå‹•");

            if (!navigator.geolocation) {
                updateStatus("ç€è¦½å™¨ä¸æ”¯æ´ GPS", "red");
                return;
            }
            
            updateStatus("æ­£åœ¨ç²å– GPS è¨Šè™Ÿ...", "orange");

            // ç›£æ§ä½ç½®
            navigator.geolocation.watchPosition(updatePosition, (err) => {
                updateStatus("GPS éŒ¯èª¤: " + err.message, "red");
            }, { enableHighAccuracy: true, timeout: 10000 });
        }

async function updatePosition(position) {
    const lat = position.coords.latitude;
    const lng = position.coords.longitude;
    const myPos = new google.maps.LatLng(lat, lng);

    document.getElementById('status').innerText = `å®šä½æˆåŠŸ: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;

    if (isSearching) return;
    isSearching = true;

    try {
        if (!service) {
            service = new google.maps.places.PlacesService(document.createElement('div'));
        }

        // æ”¹ç”¨ textSearchï¼Œé€™å° API æ¬Šé™çš„è¦æ±‚é€šå¸¸æ¯”è¼ƒå¯¬é¬†
        const request = {
            location: myPos,
            radius: 1000,
            query: 'é¤å»³' // å…ˆç”¨ä¸€å€‹å…·é«”çš„é—œéµå­—æ¸¬è©¦ï¼Œç¢ºä¿ä¸€å®šæœ‰è³‡æ–™
        };

        service.textSearch(request, (results, status) => {
            isSearching = false; 
            const statusDisplay = document.getElementById('status');

            if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                statusDisplay.innerText = `æˆåŠŸæŠ“åˆ° ${results.length} å€‹åœ°é»ï¼`;
                const logBox = document.getElementById('log');
                logBox.innerHTML = "<h3>å³æ™‚åµæ¸¬ç´€éŒ„ï¼š</h3>";
                
                results.forEach(place => {
                    processPlace(myPos, place);
                });
            } else {
                // å¦‚æœå¤±æ•—ï¼Œé€™è£¡æœƒé¡¯ç¤ºåŸå› ï¼Œå¦‚æœæ˜¯ REQUEST_DENIED å‹™å¿…æª¢æŸ¥å¸³å–®èˆ‡æ¬Šé™
                console.error("API å¤±æ•—ç‹€æ…‹:", status);
                statusDisplay.innerText = "æœå°‹å¤±æ•—: " + status;
            }
        });
    } catch (e) {
        console.error("åŸ·è¡ŒéŒ¯èª¤:", e);
        isSearching = false;
    }
}
        function renderResults(myPos, results) {
            const logBox = document.getElementById('log');
            logBox.innerHTML = `<h3>æ‰¾åˆ° ${results.length} å€‹åœ°é»ï¼š</h3>`;

            results.forEach(place => {
                const shopPos = place.geometry.location;
                const dist = Math.round(google.maps.geometry.spherical.computeDistanceBetween(myPos, shopPos));
                
                // é¡¯ç¤ºåœ¨åœ°åœ–ç´€éŒ„ä¸­
                const div = document.createElement('div');
                div.className = 'place-item';
                div.innerHTML = `<strong>ğŸ“ ${place.name}</strong><br>è·é›¢ï¼š${dist} å…¬å°º`;
                logBox.appendChild(div);

                // èªéŸ³æ’­å ±é‚è¼¯ (200å…¬å°ºå…§ä¸”æ¯åˆ†é˜åªå”¸ä¸€æ¬¡)
                const now = Date.now();
                if (dist < 200 && (!lastSpokenTime[place.name] || now - lastSpokenTime[place.name] > 60000)) {
                    const heading = google.maps.geometry.spherical.computeHeading(myPos, shopPos);
                    let dir = getDirectionText(heading);
                    speak(`${dir} ${dist} å…¬å°ºè™•æœ‰ ${place.name}`);
                    lastSpokenTime[place.name] = now;
                }
            });
        }

        function getDirectionText(heading) {
            if (heading > -45 && heading <= 45) return "å‰æ–¹";
            if (heading > 45 && heading <= 135) return "å³æ–¹";
            if (heading < -45 && heading >= -135) return "å·¦æ–¹";
            return "å¾Œæ–¹";
        }

        function speak(text) {
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'zh-TW';
            window.speechSynthesis.speak(msg);
        }

        function updateStatus(text, color) {
            const s = document.getElementById('status');
            s.innerText = text;
            s.style.color = color;
        }
    </script>
</body>
</html>