<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›²äººå°èˆªåŠ©æ‰‹æ¸¬è©¦ç‰ˆ</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC-TIvRKEtaXQONKgVK86ZAvYEnsppGEzU&libraries=places,geometry"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; background-color: #f9f9f9; }
        #status { color: blue; font-weight: bold; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ddd; }
        #log { margin-top: 20px; background: #fff; padding: 15px; border-radius: 8px; height: 400px; overflow-y: scroll; border: 1px solid #ccc; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; }
        .place-item { border-bottom: 1px solid #eee; padding: 10px 0; }
    </style>
</head>
<body>
    <h1>AI å°èˆªåŠ©æ‰‹ ğŸ¤–</h1>
    <p>ç‹€æ…‹ï¼š<span id="status">æº–å‚™ä¸­...</span></p>
    <button onclick="startNavigation()">é–‹å§‹å³æ™‚å°èˆª</button>
    <div id="log"><h3>å³æ™‚åµæ¸¬ç´€éŒ„ï¼š</h3></div>

    <script>
        let service;
        let isSearching = false; 
        let lastSpokenTime = {}; 

        function startNavigation() {
            speak("å°èˆªç³»çµ±å·²å•Ÿå‹•");
            if (!navigator.geolocation) {
                updateStatus("ç€è¦½å™¨ä¸æ”¯æ´ GPS", "red");
                return;
            }
            updateStatus("æ­£åœ¨ç²å– GPS è¨Šè™Ÿ...", "orange");
            navigator.geolocation.watchPosition(updatePosition, (err) => {
                updateStatus("GPS éŒ¯èª¤: " + err.message, "red");
            }, { enableHighAccuracy: true, timeout: 10000 });
        }

        async function updatePosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const myPos = new google.maps.LatLng(lat, lng);

            updateStatus(`å®šä½æˆåŠŸ: ${lat.toFixed(5)}, ${lng.toFixed(5)}`, "green");

            if (isSearching) return;
            isSearching = true;

            try {
                if (!service) {
                    service = new google.maps.places.PlacesService(document.createElement('div'));
                }

                // æ“´å¤§åŠå¾‘åˆ° 1000 å…¬å°ºï¼Œæœå°‹ 7-11 æ¸¬è©¦
                const request = {
                    location: myPos,
                    radius: 1000,
                    query: '7-11' 
                };

                service.textSearch(request, (results, status) => {
                    isSearching = false; 
                    if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                        renderResults(myPos, results);
                    } else {
                        updateStatus("æœå°‹å¤±æ•—: " + status, "red");
                    }
                });
            } catch (e) {
                console.error("åŸ·è¡ŒéŒ¯èª¤:", e);
                isSearching = false;
            }
        }

        function renderResults(myPos, results) {
            const logBox = document.getElementById('log');
            logBox.innerHTML = `<h3>æ‰¾åˆ° ${results.length} å€‹åœ°é»ï¼š</h3>`;

            results.forEach(place => {
                const shopPos = place.geometry.location;
                // è¨ˆç®—è·é›¢
                const dist = Math.round(google.maps.geometry.spherical.computeDistanceBetween(myPos, shopPos));
                
                // è¨ˆç®—æ–¹ä½
                const heading = google.maps.geometry.spherical.computeHeading(myPos, shopPos);
                let dir = getDirectionText(heading);

                // é¡¯ç¤ºåœ¨ç•«é¢ä¸Š
                const div = document.createElement('div');
                div.className = 'place-item';
                div.innerHTML = `<strong>ğŸ“ ${place.name}</strong><br>æ–¹ä½ï¼š${dir} | è·é›¢ï¼š${dist} å…¬å°º`;
                logBox.appendChild(div);

                // èªéŸ³æ’­å ±é‚è¼¯ (500å…¬å°ºå…§æ¸¬è©¦ï¼Œæ¯åˆ†é˜åªå”¸ä¸€æ¬¡)
                const now = Date.now();
                if (dist < 500 && (!lastSpokenTime[place.name] || now - lastSpokenTime[place.name] > 60000)) {
                    speak(`${dir} ${dist} å…¬å°ºè™•æœ‰ ${place.name}`);
                    lastSpokenTime[place.name] = now;
                }
            });
        }

        function getDirectionText(heading) {
            // å°‡è§’åº¦è½‰ç‚ºæ–‡å­—
            if (heading > -45 && heading <= 45) return "å‰æ–¹";
            if (heading > 45 && heading <= 135) return "å³æ–¹";
            if (heading < -45 && heading >= -135) return "å·¦æ–¹";
            return "å¾Œæ–¹";
        }

        function speak(text) {
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'zh-TW';
            window.speechSynthesis.speak(msg);
        }

        function updateStatus(text, color) {
            const s = document.getElementById('status');
            s.innerText = text;
            s.style.color = color;
        }
    </script>
</body>
</html>