<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›²äººå°èˆªåŠ©æ‰‹æ¸¬è©¦ç‰ˆ</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC-TIvRKEtaXQONKgVK86ZAvYEnsppGEzU&libraries=places,geometry"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
        #status { color: blue; font-weight: bold; }
        #log { margin-top: 20px; background: #f0f0f0; padding: 10px; border-radius: 5px; height: 300px; overflow-y: scroll; }
    </style>
</head>
<body>
    <h1>AI å°èˆªåŠ©æ‰‹ ğŸ¤–</h1>
    <p>ç‹€æ…‹ï¼š<span id="status">æº–å‚™ä¸­...</span></p>
    <button onclick="startNavigation()">é–‹å§‹å³æ™‚å°èˆª</button>
    <div id="log"><h3>å³æ™‚åµæ¸¬ç´€éŒ„ï¼š</h3></div>

    <script>
        let lastSpokenTime = {}; // ç”¨ä¾†é˜²æ­¢é‡è¤‡æ’­å ±åŒä¸€é–“åº—

        function startNavigation() {
            if (!navigator.geolocation) {
                alert("ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
                return;
            }
            document.getElementById('status').innerText = "å®šä½ä¸­...";
            
            // æŒçºŒè¿½è¹¤ä½ç½®
            navigator.geolocation.watchPosition(updatePosition, handleError, {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            });
        }

        function updatePosition(position) {
            const myPos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
            document.getElementById('status').innerText = `ç›®å‰ç¶“ç·¯åº¦: ${myPos.lat().toFixed(5)}, ${myPos.lng().toFixed(5)}`;
            
            // ä½¿ç”¨ Google Places API æœå°‹é™„è¿‘ 50 å…¬å°ºçš„åœ°æ¨™
            const service = new google.maps.places.PlacesService(document.createElement('div'));
            const request = {
                location: myPos,
                radius: '50', // æœå°‹åŠå¾‘ (å…¬å°º)
                type: ['store', 'school', 'restaurant', 'bus_station'] // æƒ³è¦æœå°‹çš„åœ°æ¨™é¡å‹
            };

            service.nearbySearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    results.forEach(place => {
                        processPlace(myPos, place);
                    });
                }
            });
        }

        function processPlace(myPos, place) {
            const shopPos = place.geometry.location;
            const shopName = place.name;
            
            // 1. ç›´è§€è¨ˆç®—è·é›¢ (å…¬å°º)
            const distance = Math.round(google.maps.geometry.spherical.computeDistanceBetween(myPos, shopPos));
            
            // 2. ç›´è§€è¨ˆç®—æ–¹ä½è§’
            const heading = google.maps.geometry.spherical.computeHeading(myPos, shopPos);
            let direction = "å‰æ–¹";
            if (heading > 45 && heading < 135) direction = "å³æ–¹";
            else if (heading < -45 && heading > -135) direction = "å·¦æ–¹";
            else if (heading >= 135 || heading <= -135) direction = "å¾Œæ–¹";

            // 3. æ’­å ±é‚è¼¯ï¼šå¦‚æœè·é›¢å°æ–¼ 30 å…¬å°ºä¸”ä¸€åˆ†é˜å…§æ²’å ±éé€™é–“åº—
            const currentTime = new Date().getTime();
            if (distance < 30 && (!lastSpokenTime[shopName] || currentTime - lastSpokenTime[shopName] > 60000)) {
                announce(direction, distance, shopName);
                lastSpokenTime[shopName] = currentTime;
            }
        }

        function announce(dir, dist, name) {
            const text = `${dir} ${dist} å…¬å°ºè™•æœ‰ ${name}`;
            const logEntry = document.createElement('p');
            logEntry.innerText = `[${new Date().toLocaleTimeString()}] ${text}`;
            document.getElementById('log').appendChild(logEntry);

            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'zh-TW';
            window.speechSynthesis.speak(msg);
        }

        function handleError(err) {
            console.warn(`ERROR(${err.code}): ${err.message}`);
        }
    </script>
</body>
</html>